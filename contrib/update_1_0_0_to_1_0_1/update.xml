<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.1.xsd">
  <header>
    <license>http://opensource.org/licenses/gpl-license.php GNU General Public License v2</license>
    <title lang="de">NV Exif Daten</title>
    <title lang="en-gb">NV Exif Data</title>
    <description lang="de">Zeigt die Exif-Daten der Bilder an, wenn sie als Datei-Anhang hocgeladen wurden.</description>
    <description lang="en-gb">Shows the Exif-Data on images, which were uploaded as attachments.</description>
    <author-group>
      <author>
        <realname>Joas Schilling</realname>
        <email>nickvergessen@gmx.de</email>
        <username>nickvergessen</username>
        <homepage>http://www.flying-bits.org/</homepage>
        <contributions />
      </author>
    </author-group>
    <mod-version>1.0.1</mod-version>
    <installation>
      <level>easy</level>
      <time>120</time>
      <target-version>3.0.2</target-version>
    </installation>
    <link-group>
      <link type="parent" lang="de" href="../../install.xml">Installations-Anleitung</link>
      <link type="parent" lang="en-gb" href="../../install.xml">Install</link>
      <link type="template" lang="de" href="contrib/subsilver2.xml">Anleitung f√ºr das Style subsilver2</link>
      <link type="template" lang="en-gb" href="contrib/subsilver2.xml">Manual for subsilver2 Style</link>
    </link-group>
    <meta name="generator" content="Phpbb.ModTeam.Tools (c#)" />
  </header>
  <action-group>
    <copy>
      <file from="root/language/en/mods/exif_data.php" to="language/en/mods/exif_data.php" />
    </copy>
    <open src="includes/functions_content.php">
      <edit>
        <find><![CDATA[					$exif = exif_read_data($filename, 0, true);
					if (!empty($exif["EXIF"]))
					{
						$exif_date = $exif_focal = 
						$exif_aperture = $exif_exposure = $exif_iso = $exif_whitebalance = $exif_flash = $exif_make = $exif_model = $user->lang['EXIF_NOT_AVAILABLE'];

						if(isset($exif["EXIF"]["DateTimeOriginal"]))
						{
							$timestamp = mktime(substr($exif["EXIF"]["DateTimeOriginal"], 11, 2), substr($exif["EXIF"]["DateTimeOriginal"], 14, 2), substr($exif["EXIF"]["DateTimeOriginal"], 17, 2), substr($exif["EXIF"]["DateTimeOriginal"], 5, 2), substr($exif["EXIF"]["DateTimeOriginal"], 8, 2), substr($exif["EXIF"]["DateTimeOriginal"], 0, 4));
							$exif_date = $user->format_date($timestamp);
						}
						if(isset($exif["EXIF"]["FocalLength"]))
						{
							list($num, $den) = explode("/", $exif["EXIF"]["FocalLength"]);
							$exif_focal  = ($num/$den);
						}
						if(isset($exif["EXIF"]["ExposureTime"]))
						{
							list($num, $den) = explode("/", $exif["EXIF"]["ExposureTime"]);
							$exif_exposure = '1/' . $den/$num;
						}
						if(isset($exif["EXIF"]["FNumber"]))
						{
							list($num,$den) = explode("/",$exif["EXIF"]["FNumber"]);
							$exif_aperture  = "F/" . ($num/$den);
						}
						if(isset($exif["EXIF"]["ISOSpeedRatings"]))
						{
							$exif_iso = $exif["EXIF"]["ISOSpeedRatings"];
						}
						if (isset($exif["EXIF"]["WhiteBalance"]))
						{
							$exif_whitebalance = $user->lang['EXIF_WHITEB_' . (($exif["EXIF"]["WhiteBalance"]) ? 'AUTO' : 'MANU')];
						}
						if(isset($exif["EXIF"]["Flash"]))
						{
							$exif_flash = $user->lang['EXIF_FLASH_CASE_' . $exif["EXIF"]["Flash"]];
						}
						if (isset($exif["IFD0"]["Model"]))
						{
							$exif_model = ucwords($exif["IFD0"]["Model"]);
						}

						$block_array += array(
							'EXIF_DATE'			=> $exif_date,
							'EXIF_FOCAL'		=> $exif_focal,
							'EXIF_EXPOSURE'		=> $exif_exposure,
							'EXIF_APERTURE'		=> $exif_aperture,
							'EXIF_ISO'			=> $exif_iso,
							'EXIF_FLASH'		=> $exif_flash,

							'WHITEB'		=> $exif_whitebalance,
							'CAM_MODEL'		=> $exif_model,
							'S_EXIF_DATA'	=> true,
						);
					}]]></find>
        <action type="replace-with"><![CDATA[					$exif = ($attachment['extension'] == 'jpg' || $attachment['extension'] == 'jpeg') ? @exif_read_data($filename, 0, true) : array();
					if (!empty($exif["EXIF"]))
					{
						$exif_date = $exif_focal = 
						$exif_aperture = $exif_exposure = $exif_iso = $exif_whitebalance = $exif_flash = $exif_make = $exif_model = $user->lang['EXIF_NOT_AVAILABLE'];

						if(isset($exif["EXIF"]["DateTimeOriginal"]))
						{
							$timestamp_year = substr($exif["EXIF"]["DateTimeOriginal"], 0, 4);
							$timestamp_month = substr($exif["EXIF"]["DateTimeOriginal"], 5, 2);
							$timestamp_day = substr($exif["EXIF"]["DateTimeOriginal"], 8, 2);
							$timestamp_hour = substr($exif["EXIF"]["DateTimeOriginal"], 11, 2);
							$timestamp_minute = substr($exif["EXIF"]["DateTimeOriginal"], 14, 2);
							$timestamp_second = substr($exif["EXIF"]["DateTimeOriginal"], 17, 2);
							$timestamp = mktime($timestamp_hour, $timestamp_minute, $timestamp_second, $timestamp_month, $timestamp_day, $timestamp_year);
							$exif_date = $user->format_date($timestamp);
						}
						if(isset($exif["EXIF"]["FocalLength"]))
						{
							list($num, $den) = explode("/", $exif["EXIF"]["FocalLength"]);
							$exif_focal  = ($num/$den);
						}
						if(isset($exif["EXIF"]["ExposureTime"]))
						{
							list($num, $den) = explode("/", $exif["EXIF"]["ExposureTime"]);
							$exif_exposure = '1/' . $den/$num;
						}
						if(isset($exif["EXIF"]["FNumber"]))
						{
							list($num,$den) = explode("/",$exif["EXIF"]["FNumber"]);
							$exif_aperture  = "F/" . ($num/$den);
						}
						if(isset($exif["EXIF"]["ISOSpeedRatings"]))
						{
							$exif_iso = $exif["EXIF"]["ISOSpeedRatings"];
						}
						if (isset($exif["EXIF"]["WhiteBalance"]))
						{
							$exif_whitebalance = $user->lang['EXIF_WHITEB_' . (($exif["EXIF"]["WhiteBalance"]) ? 'AUTO' : 'MANU')];
						}
						if(isset($exif["EXIF"]["Flash"]))
						{
							$exif_flash = $user->lang['EXIF_FLASH_CASE_' . $exif["EXIF"]["Flash"]];
						}
						if (isset($exif["IFD0"]["Model"]))
						{
							$exif_model = ucwords($exif["IFD0"]["Model"]);
						}

						$block_array += array(
							'EXIF_DATE'			=> htmlspecialchars($exif_date),
							'EXIF_FOCAL'		=> htmlspecialchars($exif_focal),
							'EXIF_EXPOSURE'		=> htmlspecialchars($exif_exposure),
							'EXIF_APERTURE'		=> htmlspecialchars($exif_aperture),
							'EXIF_ISO'			=> htmlspecialchars($exif_iso),
							'EXIF_FLASH'		=> htmlspecialchars($exif_flash),

							'WHITEB'		=> htmlspecialchars($exif_whitebalance),
							'CAM_MODEL'		=> htmlspecialchars($exif_model),
							'S_EXIF_DATA'	=> true,
						);
					}]]></action>
      </edit>
      <edit>
        <find><![CDATA[					$thumbnail_link = append_sid("{$phpbb_root_path}download/file.$phpEx", 'id=' . $attachment['attach_id'] . '&amp;t=1');
					$download_link .= '&amp;mode=view';]]></find>
        <action type="after-add"><![CDATA[					$exif = ($attachment['extension'] == 'jpg' || $attachment['extension'] == 'jpeg') ? @exif_read_data($filename, 0, true) : array();
					if (!empty($exif["EXIF"]))
					{
						$exif_date = $exif_focal = 
						$exif_aperture = $exif_exposure = $exif_iso = $exif_whitebalance = $exif_flash = $exif_make = $exif_model = $user->lang['EXIF_NOT_AVAILABLE'];

						if(isset($exif["EXIF"]["DateTimeOriginal"]))
						{
							$timestamp_year = substr($exif["EXIF"]["DateTimeOriginal"], 0, 4);
							$timestamp_month = substr($exif["EXIF"]["DateTimeOriginal"], 5, 2);
							$timestamp_day = substr($exif["EXIF"]["DateTimeOriginal"], 8, 2);
							$timestamp_hour = substr($exif["EXIF"]["DateTimeOriginal"], 11, 2);
							$timestamp_minute = substr($exif["EXIF"]["DateTimeOriginal"], 14, 2);
							$timestamp_second = substr($exif["EXIF"]["DateTimeOriginal"], 17, 2);
							$timestamp = mktime($timestamp_hour, $timestamp_minute, $timestamp_second, $timestamp_month, $timestamp_day, $timestamp_year);
							$exif_date = $user->format_date($timestamp);
						}
						if(isset($exif["EXIF"]["FocalLength"]))
						{
							list($num, $den) = explode("/", $exif["EXIF"]["FocalLength"]);
							$exif_focal  = ($num/$den);
						}
						if(isset($exif["EXIF"]["ExposureTime"]))
						{
							list($num, $den) = explode("/", $exif["EXIF"]["ExposureTime"]);
							$exif_exposure = '1/' . $den/$num;
						}
						if(isset($exif["EXIF"]["FNumber"]))
						{
							list($num,$den) = explode("/",$exif["EXIF"]["FNumber"]);
							$exif_aperture  = "F/" . ($num/$den);
						}
						if(isset($exif["EXIF"]["ISOSpeedRatings"]))
						{
							$exif_iso = $exif["EXIF"]["ISOSpeedRatings"];
						}
						if (isset($exif["EXIF"]["WhiteBalance"]))
						{
							$exif_whitebalance = $user->lang['EXIF_WHITEB_' . (($exif["EXIF"]["WhiteBalance"]) ? 'AUTO' : 'MANU')];
						}
						if(isset($exif["EXIF"]["Flash"]))
						{
							$exif_flash = $user->lang['EXIF_FLASH_CASE_' . $exif["EXIF"]["Flash"]];
						}
						if (isset($exif["IFD0"]["Model"]))
						{
							$exif_model = ucwords($exif["IFD0"]["Model"]);
						}

						$block_array += array(
							'EXIF_DATE'			=> htmlspecialchars($exif_date),
							'EXIF_FOCAL'		=> htmlspecialchars($exif_focal),
							'EXIF_EXPOSURE'		=> htmlspecialchars($exif_exposure),
							'EXIF_APERTURE'		=> htmlspecialchars($exif_aperture),
							'EXIF_ISO'			=> htmlspecialchars($exif_iso),
							'EXIF_FLASH'		=> htmlspecialchars($exif_flash),

							'WHITEB'		=> htmlspecialchars($exif_whitebalance),
							'CAM_MODEL'		=> htmlspecialchars($exif_model),
							'S_EXIF_DATA'	=> true,
						);
					}]]></action>
      </edit>
    </open>
    <open src="styles/prosilver/template/attachment.html">
      <edit>
        <find><![CDATA[<!-- IF _file.COMMENT --><dd> {_file.COMMENT}</dd><!-- ENDIF -->]]></find>
        <action type="after-add"><![CDATA[			<!-- IF _file.S_EXIF_DATA -->
				<hr />
				<dd><strong>{L_EXIF-DATA}</strong></dd>
				<dd>{L_EXIF_DATE}: <em>{_file.EXIF_DATE}</em></dd>
				<dd>{L_EXIF_FOCAL}: <em>{_file.EXIF_FOCAL} {L_EXIF_FOCAL_EXP}</em></dd>
				<dd>{L_EXIF_EXPOSURE}: <em>{_file.EXIF_EXPOSURE} {L_EXIF_EXPOSURE_EXP}</em></dd>
				<dd>{L_EXIF_APERTURE}: <em>{_file.EXIF_APERTURE}</em></dd>
				<dd>{L_EXIF_ISO}: <em>{_file.EXIF_ISO}</em></dd>
				<dd>{L_EXIF_FLASH}: <em>{_file.EXIF_FLASH}</em></dd>
				<dd>{L_EXIF_WHITEB}: <em>{_file.WHITEB}</em></dd>
				<dd>{L_EXIF_CAM_MODEL}: <em>{_file.CAM_MODEL}</em></dd>
			<!-- ENDIF -->]]></action>
      </edit>
    </open>
  </action-group>
</mod>